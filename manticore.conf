common {
    plugin_dir = /usr/local/lib/manticore
}

searchd {
    listen = 9306:mysql41
    listen = /var/run/mysqld/mysqld.sock:mysql41
    listen = 9312
    listen = 9308:http
    log = /var/log/manticore/searchd.log
    query_log = /var/log/manticore/query.log
    pid_file = /var/run/manticore/searchd.pid
    query_log_format = sphinxql
}

source gamenodesource {
  type             = mysql
  # Change this to the database name in docker-compose.yml, if needed.
  sql_host         = db
  sql_user         = gamenode
  sql_pass         = gamenode
  sql_db           = gamenode
# sql_query_range  = SELECT MIN(ID), MAX(ID) FROM x
  sql_query_pre    = SET CHARACTER_SET_RESULTS=utf8
  sql_query_pre    = SET NAMES utf8
  sql_query_range = SELECT MIN(game.id), MAX(game.id) FROM game
  sql_query       = SELECT game.id, game.name, game.slug, game.aggregatedRating AS aggregated_rating, game.aggregatedRatingCount as aggregated_rating_count, game.category, game.status, game.summary, game.checksum, game.url, UNIX_TIMESTAMP(game.firstReleaseDate) AS first_release_date, UNIX_TIMESTAMP(game.createdAt) AS created_at, UNIX_TIMESTAMP(game.updatedAt) AS updated_at, gameCover.url AS cover_url, gameStatistics.numViews AS num_views, gameStatistics.numLikes AS num_likes, gamePlatform.platform FROM game LEFT JOIN gamenode.game_cover AS gameCover on game.id = gameCover.gameId LEFT JOIN (SELECT gs.id, gs.gameId, count(uv.id) numViews, count(ul.id) numLikes FROM game_statistics AS gs LEFT JOIN user_view uv ON gs.id = uv.gameStatisticsId LEFT JOIN user_like ul ON gs.id = ul.gameStatisticsId GROUP BY gs.id, gs.gameId) AS gameStatistics ON game.id = gameStatistics.gameId LEFT JOIN (SELECT gpgg.gameId, GROUP_CONCAT(DISTINCT platformName SEPARATOR ', ') platform FROM (SELECT id, game_platform.abbreviation platformName FROM game_platform UNION SELECT id, game_platform.name platformName FROM game_platform) platformAll INNER JOIN game_platform_games_game gpgg ON gpgg.gamePlatformId = platformAll.id GROUP BY gpgg.gameId) AS gamePlatform ON game.id = gamePlatform.gameId WHERE game.id > $start AND game.id < $end;
  sql_attr_bigint = num_views
  sql_attr_bigint = num_likes
  sql_attr_float = aggregated_rating
  sql_attr_bigint = aggregated_rating_count
  sql_attr_timestamp = created_at
  sql_attr_timestamp = updated_at
  sql_attr_timestamp = first_release_date
  sql_attr_string = url
  sql_attr_bigint = category
  sql_attr_bigint = status
  sql_attr_string = checksum

 }

index gamenode {
  dict = keywords
  type = plain
  source = gamenodesource
  path = /var/lib/manticore/gamenode
 }
